---
import LayoutSimple from '../layouts/LayoutSimple.astro';
import { execSync } from 'node:child_process';
import ActivityCarousel from '../components/ActivityCarousel.astro';
import MatrixBanner from '../components/MatrixBanner.astro';
import Footer from '../components/Footer.astro';
import AnimatedBackground from '../components/AnimatedBackground.astro';
import { getCollection } from 'astro:content';

const allProjects = await getCollection('projects');

const projectsWithActivity = await Promise.all(
  allProjects.map(async (project) => {
    const repoUrl = project.data.githubPage;

    if (!repoUrl || !repoUrl.includes('github.com')) {
      return { ...project, lastPush: 0 };
    }

    try{
      const repoPath = repoUrl.split('github.com/')[1].replace(/\$/, '');
      const response = await fetch(`https://api.github.com/repos/${repoPath}`, {
        headers: import.meta.env.TOKEN 
          ? { Authorization: `Bearer ${import.meta.env.TOKEN}` } 
          : {}
      });

      const data = await response.json();
      // console.log(`data: ${data.name}, path: ${repoPath}, lastpush: ${new Date(data.pushed_at).getTime()}`);

      return {
        ...project,
        lastPush: new Date(data.pushed_at).getTime(),
        starts: data.stargazers_count
      };
    }
    catch (e){
      console.error(`Failed to fetch for ${project.id}:`, e);
      return { ...project, lastPush: 0 };
    }
  })
)

const activeProjects = projectsWithActivity
  .filter(p => p.lastPush > 0)
  .sort((a, b) => b.lastPush - a.lastPush)
  .slice(0, 3);

---

<LayoutSimple>
  <!-- Head -->
  <MatrixBanner />
  
  <!-- Body -->
	<ActivityCarousel projects={activeProjects} />
</LayoutSimple>
